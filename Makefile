# ================================================
#  Toolchain
# ================================================
CC      = arm-none-eabi-gcc
OBJCOPY = arm-none-eabi-objcopy

# ================================================
#  Directoare
# ================================================
SRC_DIR   = src
BUILD_DIR = build

# ================================================
#  Fișiere sursă
# ================================================
SRCS =  $(SRC_DIR)/startup.c \
        $(SRC_DIR)/main.c \
        $(SRC_DIR)/rtos_tick.c

OBJS = $(SRCS:$(SRC_DIR)/%.c=$(BUILD_DIR)/%.o)

# ================================================
#  Linker Script
# ================================================
LDSCRIPT = $(SRC_DIR)/linker.ld

# ================================================
#  Flags pentru compilare (bare-metal)
# ================================================
CFLAGS = -mcpu=cortex-m3 -mthumb \
         -O0 -g3 -Wall \
         -ffreestanding \
         -nostdlib -nostartfiles

# ================================================
#  Flags pentru linkare
# ================================================
LDFLAGS = -T $(LDSCRIPT) \
          -nostdlib \
          -Wl,--gc-sections

# ================================================
#  Fișier final
# ================================================
TARGET = $(BUILD_DIR)/rtos.elf

# ================================================
#  Regula principală
# ================================================
all: $(TARGET)

# ================================================
#  Build obiecte (.o)
# ================================================
$(BUILD_DIR)/%.o: $(SRC_DIR)/%.c
	@mkdir -p $(BUILD_DIR)
	$(CC) $(CFLAGS) -c $< -o $@

# ================================================
#  Linkare finală
# ================================================
$(TARGET): $(OBJS)
	$(CC) $(CFLAGS) $(OBJS) -o $(TARGET) $(LDFLAGS)

# ================================================
#  Clean
# ================================================
clean:
	rm -rf $(BUILD_DIR)/*